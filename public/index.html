<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Chat App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'pulse-dot': 'pulseDot 1.4s infinite ease-in-out',
                        'bounce-call': 'bounceCall 1s infinite'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        pulseDot: {
                            '0%, 80%, 100%': { transform: 'scale(0)' },
                            '40%': { transform: 'scale(1)' }
                        },
                        bounceCall: {
                            '0%, 20%, 50%, 80%, 100%': { transform: 'translateY(0)' },
                            '40%': { transform: 'translateY(-10px)' },
                            '60%': { transform: 'translateY(-5px)' }
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 h-screen flex items-center justify-center p-4">
    <!-- Username Modal -->
    <div id="usernameModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 shadow-2xl max-w-md w-full mx-4 animate-slide-up">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Join Chat</h2>
                <p class="text-gray-600">Enter your name to start chatting</p>
            </div>
            <form id="usernameForm">
                <input type="text" id="usernameInput" placeholder="Your name..." 
                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all duration-200 mb-4">
                <button type="submit" 
                        class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-xl font-semibold hover:from-blue-600 hover:to-purple-700 transition-all duration-200 transform hover:scale-[1.02]">
                    Start Chatting
                </button>
            </form>
        </div>
    </div>

    <!-- Call Modal -->
    <div id="callModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 shadow-2xl max-w-md w-full mx-4 animate-slide-up">
            <div class="text-center">
                <div id="callStatus" class="mb-6">
                    <div class="w-20 h-20 bg-gradient-to-r from-green-500 to-blue-600 rounded-full mx-auto mb-4 flex items-center justify-center animate-bounce-call">
                        <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                        </svg>
                    </div>
                    <h3 id="callTitle" class="text-xl font-bold text-gray-800 mb-2">Incoming Call</h3>
                    <p id="callDescription" class="text-gray-600">Someone is calling you...</p>
                </div>
                <div id="callButtons" class="flex space-x-4 justify-center">
                    <button id="acceptCall" class="px-6 py-3 bg-green-500 text-white rounded-xl font-semibold hover:bg-green-600 transition-all duration-200">
                        Accept
                    </button>
                    <button id="rejectCall" class="px-6 py-3 bg-red-500 text-white rounded-xl font-semibold hover:bg-red-600 transition-all duration-200">
                        Decline
                    </button>
                </div>
                <div id="callInProgress" class="hidden">
                    <button id="endCall" class="px-6 py-3 bg-red-500 text-white rounded-xl font-semibold hover:bg-red-600 transition-all duration-200">
                        End Call
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- File Upload Modal -->
    <div id="fileModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 shadow-2xl max-w-md w-full mx-4 animate-slide-up">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-gradient-to-r from-green-500 to-blue-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Upload File</h2>
                <p class="text-gray-600">Select a file to share</p>
            </div>
            <div class="mb-4">
                <input type="file" id="fileInput" class="hidden" accept="image/*,.pdf,.doc,.docx,.txt,.xls,.xlsx">
                <label for="fileInput" class="block w-full p-6 border-2 border-dashed border-gray-300 rounded-xl text-center cursor-pointer hover:border-blue-400 transition-colors duration-200">
                    <svg class="w-8 h-8 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    <span class="text-gray-600">Click to select file</span>
                </label>
            </div>
            <div id="filePreview" class="hidden mb-4 p-3 bg-gray-50 rounded-lg">
                <div class="flex items-center">
                    <svg class="w-6 h-6 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <div>
                        <div id="fileName" class="font-medium text-gray-800"></div>
                        <div id="fileSize" class="text-sm text-gray-500"></div>
                    </div>
                </div>
            </div>
            <div class="flex space-x-4">
                <button id="cancelUpload" class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-xl font-semibold hover:bg-gray-50 transition-all duration-200">
                    Cancel
                </button>
                <button id="confirmUpload" class="flex-1 px-4 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl font-semibold hover:from-blue-600 hover:to-purple-700 transition-all duration-200 disabled:opacity-50" disabled>
                    Send File
                </button>
            </div>
        </div>
    </div>

    <!-- Main Chat Interface -->
    <div id="chatContainer" class="hidden w-full max-w-6xl h-full max-h-[800px] bg-white rounded-2xl shadow-2xl overflow-hidden flex">
        <!-- Sidebar -->
        <div class="w-80 bg-gray-900 text-white flex flex-col">
            <!-- Header -->
            <div class="p-6 border-b border-gray-700 flex items-center justify-between">
                <div>
                    <h1 class="text-xl font-bold flex items-center">
                        <div class="w-3 h-3 bg-green-400 rounded-full mr-3 animate-pulse"></div>
                        Customer Care
                    </h1>
                    <p class="text-gray-400 text-sm mt-1">Real-time messaging</p>
                </div>
                <button id="callButton" class="p-2 bg-green-500 hover:bg-green-600 rounded-full transition-colors duration-200" title="Make a call">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                    </svg>
                </button>
            </div>

            <!-- Online Users -->
            <div class="p-6 flex-1">
                <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-4">Online Users</h3>
                <div id="usersList" class="space-y-2">
                    <!-- Users will be populated here -->
                </div>
            </div>

            <!-- User Info -->
            <div class="p-6 border-t border-gray-700">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mr-3">
                        <span id="userInitial" class="text-white font-semibold"></span>
                    </div>
                    <div>
                        <div id="currentUsername" class="font-semibold"></div>
                        <div class="text-xs text-gray-400">Online</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="flex-1 flex flex-col">
            <!-- Chat Header -->
            <div class="p-6 border-b border-gray-200 bg-white">
                <h2 class="text-xl font-semibold text-gray-800">General Chat</h2>
                <p class="text-gray-500 text-sm">Share your thoughts with everyone</p>
            </div>

            <!-- Messages Container -->
            <div id="messagesContainer" class="flex-1 overflow-y-auto p-6 space-y-4 bg-gray-50">
                <!-- Messages will be populated here -->
            </div>

            <!-- Typing Indicator -->
            <div id="typingIndicator" class="hidden px-6 py-2">
                <div class="flex items-center text-gray-500 text-sm">
                    <div class="flex space-x-1 mr-2">
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse-dot"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse-dot" style="animation-delay: 0.2s"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse-dot" style="animation-delay: 0.4s"></div>
                    </div>
                    <span id="typingText">Someone is typing...</span>
                </div>
            </div>

            <!-- Message Input -->
            <div class="p-6 border-t border-gray-200 bg-white">
                <form id="messageForm" class="flex space-x-4">
                    <button type="button" id="attachButton" class="px-3 py-3 text-gray-500 hover:text-blue-500 transition-colors duration-200" title="Attach file">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                        </svg>
                    </button>
                    <input type="text" id="messageInput" placeholder="Type your message..." 
                           class="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all duration-200">
                    <button type="submit" 
                            class="px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl font-semibold hover:from-blue-600 hover:to-purple-700 transition-all duration-200 transform hover:scale-[1.02] flex items-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Audio elements for calls -->
    <audio id="localAudio" autoplay muted></audio>
    <audio id="remoteAudio" autoplay></audio>

    <script>
        const socket = io();
        let currentUser = '';
        let typingTimer;
        let selectedFile = null;
        let currentCallId = null;
        let localStream = null;
        let remoteStream = null;
        let peerConnection = null;
        let connectedUsers = [];

        // DOM elements
        const usernameModal = document.getElementById('usernameModal');
        const chatContainer = document.getElementById('chatContainer');
        const usernameForm = document.getElementById('usernameForm');
        const usernameInput = document.getElementById('usernameInput');
        const messageForm = document.getElementById('messageForm');
        const messageInput = document.getElementById('messageInput');
        const messagesContainer = document.getElementById('messagesContainer');
        const usersList = document.getElementById('usersList');
        const currentUsername = document.getElementById('currentUsername');
        const userInitial = document.getElementById('userInitial');
        const typingIndicator = document.getElementById('typingIndicator');
        const typingText = document.getElementById('typingText');
        
        // File upload elements
        const fileModal = document.getElementById('fileModal');
        const attachButton = document.getElementById('attachButton');
        const fileInput = document.getElementById('fileInput');
        const filePreview = document.getElementById('filePreview');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const cancelUpload = document.getElementById('cancelUpload');
        const confirmUpload = document.getElementById('confirmUpload');

        // Call elements
        const callModal = document.getElementById('callModal');
        const callButton = document.getElementById('callButton');
        const callTitle = document.getElementById('callTitle');
        const callDescription = document.getElementById('callDescription');
        const callButtons = document.getElementById('callButtons');
        const callInProgress = document.getElementById('callInProgress');
        const acceptCall = document.getElementById('acceptCall');
        const rejectCall = document.getElementById('rejectCall');
        const endCall = document.getElementById('endCall');
        const localAudio = document.getElementById('localAudio');
        const remoteAudio = document.getElementById('remoteAudio');

        // WebRTC configuration
        const rtcConfiguration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }
            ]
        };

        // Handle username submission
        usernameForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = usernameInput.value.trim();
            if (username) {
                currentUser = username;
                currentUsername.textContent = username;
                userInitial.textContent = username.charAt(0).toUpperCase();
                
                usernameModal.classList.add('hidden');
                chatContainer.classList.remove('hidden');
                
                socket.emit('user-joined', username);
                messageInput.focus();
            }
        });

        // Handle message submission
        messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (message) {
                socket.emit('send-message', { message });
                messageInput.value = '';
                socket.emit('typing', false);
            }
        });

        // Handle typing indicator
        messageInput.addEventListener('input', () => {
            socket.emit('typing', true);
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                socket.emit('typing', false);
            }, 1000);
        });

        // File upload handlers
        attachButton.addEventListener('click', () => {
            fileModal.classList.remove('hidden');
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                selectedFile = file;
                fileName.textContent = file.name;
                fileSize.textContent = formatFileSize(file.size);
                filePreview.classList.remove('hidden');
                confirmUpload.disabled = false;
            }
        });

        cancelUpload.addEventListener('click', () => {
            fileModal.classList.add('hidden');
            selectedFile = null;
            fileInput.value = '';
            filePreview.classList.add('hidden');
            confirmUpload.disabled = true;
        });

        confirmUpload.addEventListener('click', async () => {
            if (selectedFile) {
                const formData = new FormData();
                formData.append('file', selectedFile);

                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const fileData = await response.json();
                        
                        socket.emit('send-file', {
                            fileName: fileData.originalName,
                            fileUrl: fileData.url,
                            fileSize: fileData.size,
                            fileType: fileData.mimetype
                        });

                        fileModal.classList.add('hidden');
                        selectedFile = null;
                        fileInput.value = '';
                        filePreview.classList.add('hidden');
                        confirmUpload.disabled = true;
                    }
                } catch (error) {
                    console.error('Upload failed:', error);
                    alert('Failed to upload file. Please try again.');
                }
            }
        });

        // Call handlers
        callButton.addEventListener('click', () => {
            if (connectedUsers.length > 1) {
                // For simplicity, call the first other user
                const targetUsers = connectedUsers.filter(user => user.id !== socket.id);
                if (targetUsers.length > 0) {
                    initiateCall(targetUsers[0].id);
                }
            } else {
                alert('No other users to call');
            }
        });

        acceptCall.addEventListener('click', () => {
            if (currentCallId) {
                socket.emit('call-response', { callId: currentCallId, accepted: true });
            }
        });

        rejectCall.addEventListener('click', () => {
            if (currentCallId) {
                socket.emit('call-response', { callId: currentCallId, accepted: false });
                hideCallModal();
            }
        });

        endCall.addEventListener('click', () => {
            socket.emit('end-call');
            endCurrentCall();
            hideCallModal();
        });

        // Socket event listeners
        socket.on('receive-message', (data) => {
            addMessage(data);
        });

        socket.on('user-connected', (data) => {
            addSystemMessage(data.message, 'joined');
        });

        socket.on('user-disconnected', (data) => {
            addSystemMessage(data.message, 'left');
        });

        socket.on('users-update', (users) => {
            updateUsersList(users);
        });

        socket.on('user-typing', (data) => {
            if (data.isTyping) {
                typingText.textContent = `${data.username} is typing...`;
                typingIndicator.classList.remove('hidden');
            } else {
                typingIndicator.classList.add('hidden');
            }
        });

        // Call event listeners
        socket.on('incoming-call', (data) => {
            currentCallId = data.callId;
            callTitle.textContent = 'Incoming Call';
            callDescription.textContent = `${data.callerUsername} is calling you...`;
            callButtons.classList.remove('hidden');
            callInProgress.classList.add('hidden');
            callModal.classList.remove('hidden');
        });

        socket.on('call-accepted', () => {
            callTitle.textContent = 'Call Connected';
            callDescription.textContent = 'Call in progress...';
            callButtons.classList.add('hidden');
            callInProgress.classList.remove('hidden');
        });

        socket.on('call-rejected', () => {
            hideCallModal();
            alert('Call was declined');
        });

        socket.on('call-busy', () => {
            alert('User is busy');
        });

        socket.on('call-ended', () => {
            endCurrentCall();
            hideCallModal();
        });

        socket.on('start-call', (data) => {
            startWebRTCCall(data.peerId);
        });

        // WebRTC event listeners
        socket.on('webrtc-offer', async (data) => {
            await handleOffer(data.offer, data.senderId);
        });

        socket.on('webrtc-answer', async (data) => {
            await handleAnswer(data.answer);
        });

        socket.on('webrtc-ice-candidate', async (data) => {
            await handleIceCandidate(data.candidate);
        });

        // Helper functions
        function addMessage(data) {
            const isOwnMessage = data.userId === socket.id;
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isOwnMessage ? 'justify-end' : 'justify-start'} animate-fade-in`;
            
            const time = new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            let messageContent = '';
            
            if (data.type === 'file') {
                const isImage = data.fileData.type.startsWith('image/');
                if (isImage) {
                    messageContent = `
                        <div class="mb-2">
                            <img src="${data.fileData.url}" alt="${data.fileData.name}" class="max-w-xs rounded-lg cursor-pointer" onclick="window.open('${data.fileData.url}', '_blank')">
                        </div>
                        <div class="text-sm">${escapeHtml(data.fileData.name)}</div>
                    `;
                } else {
                    messageContent = `
                        <div class="flex items-center bg-gray-100 rounded-lg p-3 mb-2">
                            <svg class="w-6 h-6 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <div>
                                <div class="font-medium text-gray-800">${escapeHtml(data.fileData.name)}</div>
                                <div class="text-sm text-gray-500">${formatFileSize(data.fileData.size)}</div>
                            </div>
                        </div>
                        <a href="${data.fileData.url}" target="_blank" class="text-blue-500 hover:underline text-sm">Download</a>
                    `;
                }
            } else {
                messageContent = `<div class="break-words">${escapeHtml(data.message)}</div>`;
            }
            
            messageDiv.innerHTML = `
                <div class="max-w-xs lg:max-w-md ${isOwnMessage ? 'order-1' : 'order-2'}">
                    <div class="${isOwnMessage ? 'bg-gradient-to-r from-blue-500 to-purple-600 text-white' : 'bg-white text-gray-800 border border-gray-200'} rounded-2xl px-4 py-3 shadow-sm">
                        ${!isOwnMessage ? `<div class="text-xs font-semibold ${isOwnMessage ? 'text-blue-100' : 'text-gray-500'} mb-1">${data.username}</div>` : ''}
                        ${messageContent}
                        <div class="text-xs ${isOwnMessage ? 'text-blue-100' : 'text-gray-400'} mt-1">${time}</div>
                    </div>
                </div>
                ${!isOwnMessage ? `
                <div class="w-8 h-8 bg-gradient-to-r from-green-400 to-blue-500 rounded-full flex items-center justify-center mr-3 order-1 flex-shrink-0">
                    <span class="text-white text-sm font-semibold">${data.username.charAt(0).toUpperCase()}</span>
                </div>
                ` : ''}
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addSystemMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex justify-center animate-fade-in';
            
            const bgColor = type === 'joined' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
            
            messageDiv.innerHTML = `
                <div class="px-4 py-2 rounded-full text-sm ${bgColor}">
                    ${escapeHtml(message)}
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function updateUsersList(users) {
            usersList.innerHTML = '';
            connectedUsers = users.map((user, index) => ({
                id: Object.keys(users)[index], // This is simplified - you'd need actual socket IDs
                name: user
            }));
            
            users.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'flex items-center py-2 px-3 rounded-lg hover:bg-gray-800 transition-colors duration-200';
                userDiv.innerHTML = `
                    <div class="w-8 h-8 bg-gradient-to-r from-green-400 to-blue-500 rounded-full flex items-center justify-center mr-3">
                        <span class="text-white text-sm font-semibold">${user.charAt(0).toUpperCase()}</span>
                    </div>
                    <div>
                        <div class="font-medium">${escapeHtml(user)} ${user === currentUser ? '(You)' : ''}</div>
                        <div class="text-xs text-green-400">Online</div>
                    </div>
                `;
                usersList.appendChild(userDiv);
            });
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Call functions
        async function initiateCall(targetUserId) {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                localAudio.srcObject = localStream;
                socket.emit('initiate-call', targetUserId);
                
                callTitle.textContent = 'Calling...';
                callDescription.textContent = 'Waiting for response...';
                callButtons.classList.add('hidden');
                callInProgress.classList.remove('hidden');
                callModal.classList.remove('hidden');
            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('Could not access microphone for call');
            }
        }

        async function startWebRTCCall(peerId) {
            peerConnection = new RTCPeerConnection(rtcConfiguration);
            
            // Add local stream to peer connection
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
            }
            
            // Handle remote stream
            peerConnection.ontrack = (event) => {
                remoteStream = event.streams[0];
                remoteAudio.srcObject = remoteStream;
            };
            
            // Handle ICE candidates
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('webrtc-ice-candidate', {
                        candidate: event.candidate,
                        targetId: peerId
                    });
                }
            };
            
            // Create and send offer
            if (!localStream) {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                localAudio.srcObject = localStream;
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
            }
            
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            socket.emit('webrtc-offer', {
                offer: offer,
                targetId: peerId
            });
        }

        async function handleOffer(offer, senderId) {
            if (!localStream) {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                localAudio.srcObject = localStream;
            }
            
            peerConnection = new RTCPeerConnection(rtcConfiguration);
            
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
            
            peerConnection.ontrack = (event) => {
                remoteStream = event.streams[0];
                remoteAudio.srcObject = remoteStream;
            };
            
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('webrtc-ice-candidate', {
                        candidate: event.candidate,
                        targetId: senderId
                    });
                }
            };
            
            await peerConnection.setRemoteDescription(offer);
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            
            socket.emit('webrtc-answer', {
                answer: answer,
                targetId: senderId
            });
        }

        async function handleAnswer(answer) {
            await peerConnection.setRemoteDescription(answer);
        }

        async function handleIceCandidate(candidate) {
            if (peerConnection) {
                await peerConnection.addIceCandidate(candidate);
            }
        }

        function endCurrentCall() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            currentCallId = null;
        }

        function hideCallModal() {
            callModal.classList.add('hidden');
        }

        // Focus username input on load
        usernameInput.focus();
    </script>
</body>
</html>